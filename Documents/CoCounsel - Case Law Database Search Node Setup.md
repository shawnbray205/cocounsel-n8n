# **CoCounsel**

## **Case Law Database Search Node Setup**

**Configuration & Integration Guide — Version 1.0**

---

## **Overview**

The Case Law Search node is a critical component of the CoCounsel workflow. It retrieves relevant case law based on search terms generated by the Issue Spotter agent, providing the raw legal data that feeds into the Case Analysis agent.

This guide covers three implementation options: building your own PostgreSQL-based case law database with semantic search, integrating with commercial legal APIs, or using the free CourtListener API.

### **Position in Workflow**

Issue Spotter Agent  
        ↓  
   Search Terms \+ Jurisdiction  
        ↓  
┌───────────────────────────────┐  
│   CASE LAW SEARCH NODE        │  ← You are here  
│   (Retrieves relevant cases)  │  
└───────────────────────────────┘  
        ↓  
   Array of Case Objects  
        ↓  
Case Analysis Agent

---

## **Implementation Options**

| Option | Best For | Pros | Cost |
| ----- | ----- | ----- | ----- |
| **Option A:** PostgreSQL \+ pgvector | Full control, custom corpus | Semantic search, your data | Low (hosting) |
| **Option B:** Commercial API | Production, comprehensive | Complete coverage, reliable | $$$ per query |
| **Option C:** CourtListener | Testing, limited use | Free, federal cases | Free |

---

## **Option A: PostgreSQL \+ pgvector (RAG)**

Build your own case law database with semantic search capabilities using PostgreSQL's pgvector extension. This provides the most control and enables true Retrieval-Augmented Generation (RAG).

### **Step 1: Create Database Schema**

First, enable the pgvector extension and create the case law table:

\-- Enable pgvector extension (Supabase has this built-in)  
CREATE EXTENSION IF NOT EXISTS vector;

\-- Create case law table with vector embeddings  
CREATE TABLE case\_law (  
    id SERIAL PRIMARY KEY,  
    case\_name TEXT NOT NULL,  
    citation TEXT NOT NULL,  
    court TEXT NOT NULL,  
    jurisdiction TEXT NOT NULL,  
    date\_decided DATE,  
    practice\_areas TEXT\[\],  
    summary TEXT,  
    holding TEXT,  
    full\_text TEXT,  
    key\_passages JSONB,  
    legal\_principles TEXT\[\],  
    cited\_cases TEXT\[\],  
    outcome TEXT,  
    relevance\_score FLOAT,  
    embedding vector(1536),  \-- For OpenAI embeddings  
    created\_at TIMESTAMPTZ DEFAULT NOW(),  
    updated\_at TIMESTAMPTZ DEFAULT NOW()  
);

\-- Create index for vector similarity search  
CREATE INDEX idx\_case\_law\_embedding  
ON case\_law USING ivfflat (embedding vector\_cosine\_ops)  
WITH (lists \= 100);

\-- Create indexes for filtered queries  
CREATE INDEX idx\_case\_law\_jurisdiction ON case\_law(jurisdiction);  
CREATE INDEX idx\_case\_law\_practice ON case\_law USING GIN(practice\_areas);  
CREATE INDEX idx\_case\_law\_date ON case\_law(date\_decided DESC);

### **Step 2: Create Semantic Search Function**

Create a PostgreSQL function for semantic similarity search:

CREATE OR REPLACE FUNCTION search\_case\_law(  
    query\_embedding vector(1536),  
    target\_jurisdiction TEXT DEFAULT NULL,  
    target\_practice\_area TEXT DEFAULT NULL,  
    match\_count INT DEFAULT 10,  
    similarity\_threshold FLOAT DEFAULT 0.7  
)  
RETURNS TABLE (  
    id INT,  
    case\_name TEXT,  
    citation TEXT,  
    court TEXT,  
    jurisdiction TEXT,  
    date\_decided DATE,  
    summary TEXT,  
    holding TEXT,  
    key\_passages JSONB,  
    legal\_principles TEXT\[\],  
    outcome TEXT,  
    similarity FLOAT  
) AS $$  
BEGIN  
    RETURN QUERY  
    SELECT  
        c.id, c.case\_name, c.citation, c.court,  
        c.jurisdiction, c.date\_decided, c.summary,  
        c.holding, c.key\_passages, c.legal\_principles,  
        c.outcome,  
        1 \- (c.embedding \<=\> query\_embedding) AS similarity  
    FROM case\_law c  
    WHERE  
        (target\_jurisdiction IS NULL OR  
         c.jurisdiction ILIKE target\_jurisdiction)  
        AND (target\_practice\_area IS NULL OR  
             target\_practice\_area \= ANY(c.practice\_areas))  
        AND 1 \- (c.embedding \<=\> query\_embedding) \> similarity\_threshold  
    ORDER BY c.embedding \<=\> query\_embedding  
    LIMIT match\_count;  
END;  
$$ LANGUAGE plpgsql;

### **Step 3: Configure n8n Nodes**

You'll need two nodes: one to generate embeddings and one to search the database.

#### **Node 3a: Generate Embedding (HTTP Request)**

1. Add an HTTP Request node after the Issue Spotter  
2. Set Method: **POST**  
3. Set URL: **https://api.openai.com/v1/embeddings**  
4. Add Header: `Authorization: Bearer {{ $credentials.openAiApi.apiKey }}`  
5. Set Body (JSON):

{  
  "model": "text-embedding-3-small",  
  "input": "{{ $json.searchTerms.join(' ') }}"  
}

#### **Node 3b: Search Case Law (PostgreSQL)**

1. Add a PostgreSQL node after the embedding node  
2. Set Operation: **Execute Query**  
3. Select your PostgreSQL credential  
4. Set Query:

SELECT \* FROM search\_case\_law(  
    '{{ $json.data\[0\].embedding }}'::vector,  
    '{{ $node\["Issue Spotter"\].json.jurisdiction }}',  
    '{{ $node\["Issue Spotter"\].json.practiceArea }}',  
    10,  
    0.7  
);

### **Step 4: Populate Case Law Database**

You'll need to populate your database with case law data. Here's a sample data structure:

// Sample case law data structure  
const caseData \= {  
  case\_name: "Edwards v. Arthur Andersen LLP",  
  citation: "44 Cal.4th 937 (2008)",  
  court: "California Supreme Court",  
  jurisdiction: "California",  
  date\_decided: "2008-08-07",  
  practice\_areas: \["Employment Law", "Contract Law"\],  
  summary: "Established that non-compete agreements...",  
  holding: "Business and Professions Code section 16600...",  
  legal\_principles: \[  
    "Non-compete clauses void under Cal B\&P 16600",  
    "Narrow restraint exception does not apply"  
  \],  
  outcome: "Reversed and remanded"  
};

**TIP:** Sources for case law data include CourtListener bulk downloads, Caselaw Access Project (Harvard), and state court websites.

---

## **Option B: Commercial Legal APIs**

For production deployments requiring comprehensive case coverage, integrate with a commercial legal research API.

### **API Comparison**

| Provider | Coverage | Pricing Model |
| ----- | ----- | ----- |
| **Casetext** | Federal \+ all 50 states, AI-enhanced | Per-query or subscription |
| **Westlaw API** | Most comprehensive, KeyCite | Enterprise licensing |
| **LexisNexis** | Comprehensive, Shepard's Citations | Enterprise licensing |
| **vLex** | International coverage, developer-friendly | API access tiers |

### **Casetext API Integration Example**

1. Add an HTTP Request node  
2. Set Method: **POST**  
3. Set URL: **https://api.casetext.com/v1/search**  
4. Configure Headers and Body:

// Headers  
Authorization: Bearer {{ $credentials.casetextApi.apiKey }}  
Content-Type: application/json

// Body  
{  
  "query": "{{ $json.searchTerms.join(' ') }}",  
  "jurisdiction": "{{ $json.jurisdiction }}",  
  "practice\_area": "{{ $json.practiceArea }}",  
  "limit": 10,  
  "include\_full\_text": true  
}

---

## **Option C: CourtListener API (Free)**

CourtListener is a free, open-source legal research platform run by Free Law Project. It provides access to federal court opinions and is ideal for testing or limited deployments.

### **API Setup**

1. Create a free account at **https://www.courtlistener.com/sign-in/**  
2. Go to your profile and generate an API token  
3. Note: Rate limit is 5,000 requests/hour

### **n8n HTTP Request Configuration**

1. Add an HTTP Request node  
2. Set Method: **GET**  
3. Set URL: `https://www.courtlistener.com/api/rest/v4/search/`  
4. Add Header:

Authorization: Token {{ $credentials.courtListenerApi.token }}

5. Add Query Parameters:

| Parameter | Value |
| ----- | ----- |
| **q** | {{ $json.searchTerms.join(' ') }} |
| **type** | o (for opinions) |
| **court** | {{ $json.jurisdiction }} (e.g., ca9, scotus) |
| **order\_by** | score desc |

### **Transform CourtListener Response**

Add a Code node after the HTTP Request to transform the response into CoCounsel's expected format:

// Transform CourtListener response to CoCounsel format  
const results \= $input.first().json.results || \[\];

const cases \= results.map(result \=\> ({  
  caseName: result.caseName,  
  citation: result.citation ? result.citation\[0\] : 'No citation',  
  court: result.court,  
  jurisdiction: result.court\_id,  
  dateDecided: result.dateFiled,  
  summary: result.snippet || 'No summary available',  
  holding: result.snippet,  
  fullTextUrl: \`https://www.courtlistener.com${result.absolute\_url}\`,  
  relevanceScore: result.score  
}));

return { cases };

**LIMITATION:** CourtListener primarily covers federal courts. State court coverage varies. For comprehensive state law research, use Option A or B.

---

## **Expected Output Format**

Regardless of which option you choose, the Case Law Search node should output data in this format for the Case Analysis agent:

{  
  "cases": \[  
    {  
      "caseName": "Edwards v. Arthur Andersen LLP",  
      "citation": "44 Cal.4th 937 (2008)",  
      "court": "California Supreme Court",  
      "jurisdiction": "California",  
      "dateDecided": "2008-08-07",  
      "summary": "Established that non-compete...",  
      "holding": "Business and Professions Code...",  
      "keyPassages": \[  
        "Section 16600 represents...",  
        "California courts have..."  
      \],  
      "legalPrinciples": \[  
        "Non-compete clauses void under Cal B\&P 16600",  
        "Narrow restraint exception inapplicable"  
      \],  
      "outcome": "Reversed and remanded",  
      "relevanceScore": 0.95  
    }  
  \]  
}

---

## **Troubleshooting**

### **Common Issues**

1. **No results returned**

   * Check that search terms are being passed correctly from Issue Spotter  
   * Verify jurisdiction filter matches expected format  
   * Lower similarity threshold for pgvector (try 0.5)  
2. **pgvector embedding dimension mismatch**

   * Ensure embedding model matches vector column size  
   * text-embedding-3-small \= 1536 dimensions  
   * text-embedding-3-large \= 3072 dimensions  
3. **API rate limiting**

   * Add retry logic with exponential backoff  
   * Cache frequently searched queries  
   * Consider upgrading API tier for production use  
4. **Slow vector search performance**

   * Ensure ivfflat index was created on embedding column  
   * Increase 'lists' parameter for larger datasets  
   * Consider HNSW index for better recall  
5. **Case Analysis agent receiving empty data**

   * Check node connection between Case Law Search and Case Analysis  
   * Verify output format matches expected schema  
   * Add a Set node to reshape data if needed

### **Testing Your Setup**

1. Test the embedding generation node independently  
2. Verify database connection with a simple SELECT query  
3. Test semantic search with known case law  
4. Run full workflow with sample legal query  
5. Check Case Analysis agent output quality

---

*— End of Case Law Search Setup Guide —*

